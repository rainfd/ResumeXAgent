# 数据库模式

将概念数据模型转换为具体的SQLite数据库模式：

```sql
-- 简历表
CREATE TABLE resumes (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    original_filename TEXT NOT NULL,
    file_type TEXT CHECK(file_type IN ('pdf', 'markdown', 'txt')) NOT NULL,
    raw_text TEXT NOT NULL,
    parsed_data JSON,
    basic_info JSON,
    education JSON,
    work_experience JSON,
    projects JSON,
    skills JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 岗位表
CREATE TABLE jobs (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    url TEXT UNIQUE,
    title TEXT NOT NULL,
    company TEXT NOT NULL,
    location TEXT,
    salary_range TEXT,
    experience_required TEXT,
    education_required TEXT,
    raw_description TEXT NOT NULL,
    parsed_requirements JSON,
    technical_skills JSON,
    soft_skills JSON,
    responsibilities JSON,
    company_info JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 分析结果表
CREATE TABLE analyses (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    resume_id TEXT NOT NULL,
    job_id TEXT,
    analysis_type TEXT NOT NULL CHECK(
        analysis_type IN ('star_check', 'optimization', 'grammar_check', 'custom')
    ),
    ai_model TEXT NOT NULL,
    results JSON NOT NULL,
    suggestions JSON,
    score REAL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resume_id) REFERENCES resumes(id) ON DELETE CASCADE,
    FOREIGN KEY (job_id) REFERENCES jobs(id) ON DELETE CASCADE
);

-- 岗位匹配表
CREATE TABLE job_matches (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    resume_id TEXT NOT NULL,
    job_id TEXT NOT NULL,
    match_score REAL CHECK(match_score >= 0 AND match_score <= 100),
    skill_match JSON,
    experience_match JSON,
    education_match JSON,
    strengths JSON,
    gaps JSON,
    recommendations JSON,
    hr_message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resume_id) REFERENCES resumes(id) ON DELETE CASCADE,
    FOREIGN KEY (job_id) REFERENCES jobs(id) ON DELETE CASCADE,
    UNIQUE(resume_id, job_id)
);

-- 自定义提示词表
CREATE TABLE custom_prompts (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    name TEXT NOT NULL,
    description TEXT,
    prompt_template TEXT NOT NULL,
    ai_model TEXT,
    category TEXT,
    usage_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引以优化查询性能
CREATE INDEX idx_resumes_created_at ON resumes(created_at DESC);
CREATE INDEX idx_jobs_company ON jobs(company);
CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
CREATE INDEX idx_analyses_resume_id ON analyses(resume_id);
CREATE INDEX idx_analyses_job_id ON analyses(job_id);
CREATE INDEX idx_analyses_type ON analyses(analysis_type);
CREATE INDEX idx_job_matches_resume_id ON job_matches(resume_id);
CREATE INDEX idx_job_matches_job_id ON job_matches(job_id);
CREATE INDEX idx_job_matches_score ON job_matches(match_score DESC);
CREATE INDEX idx_custom_prompts_category ON custom_prompts(category);

-- 创建触发器自动更新updated_at字段
CREATE TRIGGER update_resumes_updated_at 
AFTER UPDATE ON resumes
BEGIN
    UPDATE resumes SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;

CREATE TRIGGER update_custom_prompts_updated_at
AFTER UPDATE ON custom_prompts
BEGIN
    UPDATE custom_prompts SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

## 数据库设计说明

1. **UUID主键生成：** 使用SQLite的randomblob函数生成UUID，确保唯一性
2. **JSON字段：** 利用SQLite的JSON支持存储半结构化数据，提供灵活性
3. **外键约束：** 确保数据完整性，级联删除避免孤立记录
4. **索引策略：** 
   - 为常用查询字段创建索引
   - 时间字段使用降序索引优化最新记录查询
   - 匹配分数使用降序索引便于排序
5. **触发器：** 自动维护updated_at字段，无需应用层处理
6. **CHECK约束：** 确保枚举值和数值范围的有效性
