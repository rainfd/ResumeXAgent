# 测试策略和标准

全面的测试策略，确保代码质量和系统可靠性：

## 测试理念
- **方法：** 测试驱动开发（TDD）为可选，关键功能必须有测试
- **覆盖目标：** 端到端测试100%覆盖核心用户流程
- **测试金字塔：** 重点在端到端测试（60%）、集成测试（30%）、单元测试（10%）

## 测试类型和组织

### 端到端测试
- **框架：** Playwright Test 1.42.0
- **文件约定：** `*.spec.ts`在tests/e2e目录
- **位置：** `tests/e2e/`
- **覆盖要求：** 所有用户故事的主要路径

**AI代理要求：**
- 为每个Epic至少创建一个端到端测试
- 测试完整的用户流程，从登录到结果展示
- 包含正常路径和异常处理测试
- 使用Page Object模式组织测试代码

```typescript
// 示例：简历上传端到端测试
import { test, expect } from '@playwright/test';

test.describe('简历上传流程', () => {
  test('应该成功上传并解析PDF简历', async ({ page }) => {
    await page.goto('/resume/upload');
    
    // 上传文件
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/fixtures/sample-resume.pdf');
    
    // 等待解析完成
    await expect(page.locator('.parse-result')).toBeVisible();
    
    // 验证解析结果
    await expect(page.locator('.basic-info')).toContainText('张三');
    await expect(page.locator('.skills')).toContainText('TypeScript');
  });
  
  test('应该处理无效文件类型', async ({ page }) => {
    await page.goto('/resume/upload');
    
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/fixtures/invalid.exe');
    
    await expect(page.locator('.error-message'))
      .toContainText('仅支持PDF、Markdown和文本文件');
  });
});
```

### 集成测试
- **范围：** API端点测试、服务间集成
- **位置：** 各服务目录下的`*.test.ts`文件
- **测试基础设施：**
  - **数据库：** 使用内存SQLite进行测试
  - **外部API：** 使用MSW (Mock Service Worker)模拟

```typescript
// 示例：API集成测试
import { createMocks } from 'node-mocks-http';
import handler from '@/app/api/resume/upload/route';

describe('POST /api/resume/upload', () => {
  it('应该成功处理简历上传', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: { /* 测试数据 */ }
    });
    
    await handler(req, res);
    
    expect(res._getStatusCode()).toBe(200);
    expect(JSON.parse(res._getData())).toHaveProperty('resumeId');
  });
});
```

### 单元测试
- **框架：** Jest (Next.js内置)
- **文件约定：** `*.test.ts`与源文件同目录
- **模拟库：** Jest内置mock功能
- **覆盖要求：** 工具函数和关键业务逻辑

## 测试数据管理
- **策略：** 使用固定的测试数据文件
- **Fixtures：** `tests/fixtures/`目录存放测试文件
- **工厂模式：** 创建测试数据生成器
- **清理：** 每个测试后自动清理数据

## 持续测试
- **CI集成：** GitHub Actions运行所有测试
- **性能测试：** 使用Playwright测量关键操作时间
- **安全测试：** 依赖扫描，输入验证测试

## 测试脚本

```json
{
  "scripts": {
    "test": "playwright test",
    "test:e2e": "playwright test tests/e2e",
    "test:watch": "playwright test --watch",
    "test:debug": "playwright test --debug",
    "test:report": "playwright show-report"
  }
}
```
