# 错误处理策略

定义全面的错误处理方法，确保系统稳定性和良好的用户体验：

## 通用方法
- **错误模型：** 统一错误格式，包含错误码、消息、上下文
- **异常层次：** 业务异常、系统异常、外部服务异常分层处理
- **错误传播：** 使用Result类型或try-catch，避免未处理异常

## 日志标准
- **库：** winston 3.11.0
- **格式：** JSON格式，包含时间戳、级别、消息、上下文
- **级别：** error, warn, info, debug
- **必需上下文：**
  - 关联ID：每个请求生成唯一ID用于追踪
  - 服务上下文：组件名称、方法名
  - 用户上下文：不记录敏感信息

## 错误处理模式

### 外部API错误
- **重试策略：** 指数退避，最多3次重试
- **熔断器：** 连续5次失败后熔断30秒
- **超时配置：** OpenRouter 30秒，DeepSeek 30秒，浏览器操作60秒
- **错误转换：** 将外部错误转换为用户友好消息

```typescript
// 示例：AI服务错误处理
class AIServiceError extends Error {
  constructor(
    public code: string,
    message: string,
    public retryable: boolean = false
  ) {
    super(message);
  }
}

// 重试装饰器
async function withRetry<T>(
  fn: () => Promise<T>,
  maxRetries = 3
): Promise<T> {
  let lastError;
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      if (!isRetryable(error)) throw error;
      await sleep(Math.pow(2, i) * 1000); // 指数退避
    }
  }
  throw lastError;
}
```

### 业务逻辑错误
- **自定义异常：** ResumeParseError, JobFetchError, MatchingError等
- **用户友好错误：** 转换技术错误为用户可理解的消息
- **错误码系统：** 
  - 1xxx: 输入验证错误
  - 2xxx: 业务逻辑错误
  - 3xxx: 外部服务错误
  - 4xxx: 系统错误

### 数据一致性
- **事务策略：** SQLite事务确保原子性操作
- **补偿逻辑：** 文件上传失败时清理临时文件
- **幂等性：** API设计支持重试，使用请求ID防重

## 用户错误展示

```typescript
// 错误响应格式
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: any;
    timestamp: string;
    requestId: string;
  };
}

// 用户友好错误消息映射
const ERROR_MESSAGES = {
  'FILE_TOO_LARGE': '文件大小超过10MB限制',
  'INVALID_FILE_TYPE': '仅支持PDF、Markdown和文本文件',
  'AI_SERVICE_UNAVAILABLE': 'AI服务暂时不可用，请稍后重试',
  'BROWSER_TIMEOUT': '获取岗位信息超时，请检查网络连接',
  'DATABASE_ERROR': '数据保存失败，请重试',
};
```

## 监控和告警

- **错误追踪：** 本地错误日志文件，按日期轮转
- **性能监控：** 记录API响应时间，识别性能瓶颈
- **健康检查：** /api/health端点检查系统状态
- **错误统计：** 定期生成错误报告，识别高频问题
