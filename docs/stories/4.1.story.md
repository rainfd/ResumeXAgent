# Story 4.1: 集成 AI 模型进行 STAR 法则分析

## Status

Draft

## Story

**As a** 用户，
**I want** AI 帮我检查项目经历是否符合 STAR 法则，
**so that** 让我的经历描述更有说服力

## Acceptance Criteria

1. 调用 AI API（OpenRouter/DeepSeek）分析项目经历
2. AI 识别每个项目缺少哪些 STAR 要素
3. 为缺失的要素生成具体的补充建议
4. 提供符合 STAR 法则的改写示例
5. 支持批量分析多个项目经历
6. 清晰标注哪些部分需要补充（如"缺少具体成果说明"）

## Tasks / Subtasks

- [ ] Task 1: 创建STAR分析服务 (AC: 1, 2)
  - [ ] 创建 `lib/services/star-analyzer.service.ts` STAR分析服务
  - [ ] 实现AI API调用（OpenRouter/DeepSeek）
  - [ ] 开发STAR要素识别算法
  - [ ] 集成项目经历提取功能
  - [ ] 添加API错误处理和重试机制
- [ ] Task 2: 实现STAR要素缺失检测 (AC: 2, 6)
  - [ ] 创建 `lib/analyzers/star-element.analyzer.ts` STAR要素分析器
  - [ ] 实现Situation（情况）要素检测
  - [ ] 实现Task（任务）要素检测
  - [ ] 实现Action（行动）要素检测
  - [ ] 实现Result（结果）要素检测
  - [ ] 开发缺失要素标注功能
- [ ] Task 3: 开发补充建议生成 (AC: 3)
  - [ ] 创建 `lib/generators/star-suggestion.generator.ts` 建议生成器
  - [ ] 实现具体补充建议算法
  - [ ] 开发针对性改进提示
  - [ ] 集成AI模型生成个性化建议
  - [ ] 添加建议的可操作性验证
- [ ] Task 4: 构建改写示例生成 (AC: 4)
  - [ ] 创建 `lib/generators/star-rewrite.generator.ts` 改写生成器
  - [ ] 实现基于原始内容的改写功能
  - [ ] 开发符合STAR法则的模板系统
  - [ ] 添加多版本改写选项
  - [ ] 实现改写质量评估
- [ ] Task 5: 实现批量分析功能 (AC: 5)
  - [ ] 创建 `lib/services/batch-star-analyzer.service.ts` 批量分析服务
  - [ ] 实现项目经历批量处理
  - [ ] 开发并行分析机制
  - [ ] 添加分析进度跟踪
  - [ ] 实现批量结果汇总
- [ ] Task 6: 创建STAR分析UI组件 (AC: 1-6)
  - [ ] 创建 `components/analysis/star-checker.tsx` STAR检测组件
  - [ ] 实现项目经历选择界面
  - [ ] 开发STAR要素可视化展示
  - [ ] 添加缺失要素高亮功能
  - [ ] 实现建议和改写展示界面
- [ ] Task 7: 集成STAR分析API (AC: 1-6)
  - [ ] 创建 `app/api/analysis/star/route.ts` STAR分析API
  - [ ] 实现简历数据获取
  - [ ] 集成STAR分析服务
  - [ ] 添加分析结果存储
  - [ ] 实现分析历史管理

## Dev Notes

### Previous Story Insights [Source: Story 2.3-2.4 Dev Agent Records]

- **AI集成经验**: DeepSeek API已成功集成，具有完整的错误处理和超时控制机制
- **结构化数据就绪**: 简历项目经历已通过提取器标准化存储，可直接用于STAR分析
- **UI组件基础**: 现有分析结果展示组件可复用于STAR检测结果展示
- **API设计模式**: 已建立标准的API响应格式和错误处理模式

### 技术栈要求 [Source: architecture/技术栈.md]

- **AI服务**: OpenRouter API（多模型支持）+ DeepSeek API（中文优化）
- **HTTP客户端**: axios 1.6.0（拦截器支持、错误处理、超时控制）
- **数据库**: SQLite（STAR分析结果存储）
- **类型系统**: TypeScript 5.3.3（严格类型检查）
- **UI框架**: React 18.3.0 + shadcn/ui（分析结果展示）

### STAR分析架构设计 [Source: architecture/核心工作流程.md#STAR法则检测流程]

**STAR分析服务接口:**

```typescript
interface StarAnalyzerService {
  analyzeProject(projectText: string): Promise<StarAnalysisResult>;
  analyzeBatch(projects: ProjectExperience[]): Promise<BatchStarAnalysisResult>;
  generateSuggestions(analysis: StarAnalysisResult): Promise<StarSuggestion[]>;
  generateRewrite(originalText: string, missingElements: StarElement[]): Promise<StarRewriteOptions>;
}

interface StarAnalysisResult {
  projectId: string;
  detectedElements: StarElementDetection;
  missingElements: StarElement[];
  completenessScore: number;
  suggestions: StarSuggestion[];
}

interface StarElementDetection {
  situation: ElementScore;
  task: ElementScore;
  action: ElementScore;
  result: ElementScore;
}

interface ElementScore {
  detected: boolean;
  confidence: number;
  extractedText?: string;
  suggestions: string[];
}
```

### AI服务集成规范 [Source: architecture/外部api.md]

**OpenRouter API配置:**
- 基础URL: https://openrouter.ai/api/v1
- 认证: Bearer Token（环境变量OPENROUTER_API_KEY）
- 速率限制: 60请求/分钟
- 重试策略: 指数退避，最多3次重试

**DeepSeek API配置:**
- 基础URL: https://api.deepseek.com/v1
- 认证: API Key（环境变量DEEPSEEK_API_KEY）
- 速率限制: 100请求/分钟
- 优先用于中文内容分析

### 数据模型扩展 [Source: architecture/数据模型.md#Analysis]

**新增STAR分析结果存储:**

```typescript
interface StarAnalysis extends BaseAnalysis {
  analysis_type: 'star_check';
  results: StarAnalysisResult;
  suggestions: StarSuggestion[];
  rewrite_options: StarRewriteOptions[];
  batch_id?: string; // 批量分析标识
}

interface StarSuggestion {
  element: StarElement;
  suggestion: string;
  priority: 'high' | 'medium' | 'low';
  actionable: boolean;
}

interface StarRewriteOptions {
  version: number;
  rewritten_text: string;
  improvements: string[];
  confidence: number;
}
```

### STAR要素检测规则

**Situation（情况）检测:**
- 背景描述关键词：项目背景、业务需求、遇到问题、面临挑战
- 上下文指示器：当时、那时候、项目初期、面对
- 缺失标识：缺少项目背景说明、未描述具体情况

**Task（任务）检测:**
- 任务描述关键词：负责、承担、需要完成、目标是
- 责任指示器：我的任务、职责范围、需要实现
- 缺失标识：任务职责不明确、目标描述模糊

**Action（行动）检测:**
- 行动描述关键词：采用、使用、实施、开发、设计
- 具体行为：分析、设计、编码、测试、优化、协调
- 缺失标识：具体行动不详细、方法措施缺失

**Result（结果）检测:**
- 结果描述关键词：最终、结果、成果、效果、提升
- 量化指示器：百分比、数字、倍数、时间缩短
- 缺失标识：缺少具体成果、无量化指标

### 项目结构要求 [Source: architecture/源代码树.md]

**STAR分析相关文件:**

```
lib/services/
├── star-analyzer.service.ts      # 主要STAR分析服务
└── batch-star-analyzer.service.ts # 批量分析服务

lib/analyzers/
├── star-element.analyzer.ts      # STAR要素分析器
└── project-content.analyzer.ts   # 项目内容预处理

lib/generators/
├── star-suggestion.generator.ts  # 建议生成器
└── star-rewrite.generator.ts     # 改写生成器

lib/types/
├── star-analysis.types.ts        # STAR分析类型定义
└── star-element.types.ts         # STAR要素类型定义

components/analysis/
├── star-checker.tsx              # STAR检测主组件
├── star-element-display.tsx      # STAR要素展示
├── star-suggestions.tsx          # 改进建议组件
└── star-rewrite-options.tsx      # 改写选项组件

app/api/analysis/
└── star/route.ts                 # STAR分析API接口
```

### 性能和用户体验要求

**分析性能:**
- 单个项目经历分析时间 < 15秒
- 批量分析支持并发处理（最多5个项目同时）
- AI API调用缓存相似内容结果
- 实时进度显示和可取消操作

**用户体验:**
- 分析过程可视化进度条
- STAR要素缺失高亮显示
- 建议按重要性排序展示
- 改写选项提供多个版本供选择

### AI成本控制策略

**分层分析策略:**
1. **基础检测**: 规则引擎检测明显的STAR要素（快速、免费）
2. **AI深度分析**: 对复杂文本使用AI分析（精确、付费）
3. **智能路由**: 根据文本复杂度选择分析方式

**成本优化措施:**
- 缓存相同项目经历的分析结果
- 批量处理减少API调用次数
- 用户选择分析深度（基础/深度/专业）
- 预设分析配额和使用限制

### Testing Requirements [Source: architecture/测试策略和标准.md]

**测试数据准备:**
- 包含完整STAR要素的项目经历样本
- 缺失不同STAR要素的测试案例
- 中英文混合的项目描述测试
- 边缘情况和异常格式测试

**测试指标:**
- STAR要素检测准确率（>85%）
- 建议生成相关性（>90%）
- 改写质量评估（人工评估>80%满意度）
- 批量分析性能（<5分钟/10个项目）

### 安全和隐私考虑

**数据安全:**
- AI调用时项目内容脱敏处理
- 分析历史定期清理（30天）
- 敏感信息过滤（公司机密、个人隐私）
- API调用日志安全存储

## Change Log

| Date       | Version | Description                        | Author       |
| ---------- | ------- | ---------------------------------- | ------------ |
| 2025-08-09 | 1.0     | 初始故事创建，基于Epic 4.1要求     | Scrum Master |

## Dev Agent Record

### Agent Model Used

待实现

### Debug Log References

待实现

### Completion Notes List

待实现

### File List

待实现

## QA Results

### Review Date

待审查

### Reviewed By

待指定