# Story 5.1: 集成 AI API 基础设施

## Status

Draft

## Story

**As a** 开发者，
**I want** 建立稳定的 AI API 集成框架，
**so that** 支持各种 AI 功能的实现

## Acceptance Criteria

1. 实现 OpenRouter API 的集成和调用封装
2. 实现 DeepSeek API 的集成和调用封装
3. 创建 API 密钥的安全管理机制（环境变量）
4. 实现 API 调用的错误处理和重试机制
5. 创建 API 使用情况的本地记录（调用次数、模型类型）
6. 支持在设置页面切换不同的 API 和模型

## Tasks / Subtasks

- [ ] Task 1: 创建统一AI服务抽象层 (AC: 1, 2)
  - [ ] 创建 `lib/services/ai/base-ai.service.ts` AI服务基类
  - [ ] 实现通用的AI调用接口定义
  - [ ] 开发模型配置管理功能
  - [ ] 添加API响应标准化处理
  - [ ] 实现服务工厂模式
- [ ] Task 2: 实现OpenRouter API集成 (AC: 1)
  - [ ] 创建 `lib/services/ai/openrouter-ai.service.ts` OpenRouter服务
  - [ ] 实现OpenRouter API调用封装
  - [ ] 集成多模型支持功能
  - [ ] 添加模型参数配置机制
  - [ ] 实现流式响应处理
- [ ] Task 3: 实现DeepSeek API集成 (AC: 2)
  - [ ] 创建 `lib/services/ai/deepseek-ai.service.ts` DeepSeek服务
  - [ ] 实现DeepSeek API调用封装
  - [ ] 优化中文处理能力
  - [ ] 添加模型特定参数支持
  - [ ] 实现响应质量评估
- [ ] Task 4: 构建API密钥安全管理 (AC: 3)
  - [ ] 创建 `lib/config/ai-config.manager.ts` AI配置管理器
  - [ ] 实现环境变量安全加载
  - [ ] 开发API密钥验证功能
  - [ ] 添加配置加密存储机制
  - [ ] 实现配置热更新支持
- [ ] Task 5: 开发错误处理和重试机制 (AC: 4)
  - [ ] 创建 `lib/utils/ai-retry.util.ts` AI重试工具
  - [ ] 实现指数退避重试算法
  - [ ] 开发错误分类和处理策略
  - [ ] 添加熔断器模式支持
  - [ ] 实现降级机制和备用方案
- [ ] Task 6: 构建使用情况记录系统 (AC: 5)
  - [ ] 创建 `lib/trackers/ai-usage.tracker.ts` AI使用跟踪器
  - [ ] 实现调用次数统计功能
  - [ ] 开发成本分析和预警
  - [ ] 添加使用模式分析
  - [ ] 实现使用历史查询接口
- [ ] Task 7: 创建AI设置管理界面 (AC: 6)
  - [ ] 创建 `components/settings/ai-settings.tsx` AI设置组件
  - [ ] 实现API提供商选择界面
  - [ ] 开发模型选择和配置功能
  - [ ] 添加使用情况展示面板
  - [ ] 实现设置保存和验证
- [ ] Task 8: 集成AI服务API接口 (AC: 1-6)
  - [ ] 创建 `app/api/ai/config/route.ts` AI配置API
  - [ ] 实现AI服务调用统一接口
  - [ ] 集成使用情况查询API
  - [ ] 添加健康检查和监控接口
  - [ ] 实现配置管理API

## Dev Notes

### Previous Story Insights [Source: Story 2.3-4.5 Dev Notes]

- **AI集成经验**: DeepSeek API已在语法检测和STAR分析中成功使用，具备完整的错误处理机制
- **API调用模式**: 已建立标准的HTTP客户端使用模式，可复用axios配置和超时控制
- **环境配置管理**: 项目已有基础的环境变量管理，可扩展为AI API密钥管理
- **用户界面基础**: 已有设置界面的UI组件基础，可扩展为AI配置界面

### 技术栈要求 [Source: architecture/技术栈.md]

- **HTTP客户端**: axios 1.6.0（拦截器支持、错误处理、超时控制）
- **环境配置**: dotenv 16.4.0（API密钥安全管理，开发生产环境分离）
- **数据库**: SQLite（AI使用情况记录和配置存储）
- **类型系统**: TypeScript 5.3.3（严格类型检查）
- **UI框架**: React 18.3.0 + shadcn/ui（AI设置界面）

### AI服务架构设计

**AI服务抽象层接口:**

```typescript
interface BaseAIService {
  provider: AIProvider;
  models: AIModel[];
  
  // 核心调用方法
  chat(messages: ChatMessage[], options?: ChatOptions): Promise<AIResponse>;
  streamChat(messages: ChatMessage[], options?: ChatOptions): AsyncGenerator<AIStreamChunk>;
  
  // 配置管理
  configure(config: AIServiceConfig): void;
  validateConfig(): Promise<boolean>;
  
  // 健康检查
  healthCheck(): Promise<HealthStatus>;
  getSupportedModels(): Promise<AIModel[]>;
}

interface ChatOptions {
  model?: string;
  temperature?: number;
  maxTokens?: number;
  stopSequences?: string[];
  presencePenalty?: number;
  frequencyPenalty?: number;
  stream?: boolean;
}

interface AIResponse {
  id: string;
  provider: AIProvider;
  model: string;
  content: string;
  usage: TokenUsage;
  finishReason: 'stop' | 'length' | 'content_filter';
  metadata: ResponseMetadata;
}

interface TokenUsage {
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
  estimatedCost: number;
}
```

### AI API 集成规范 [Source: architecture/外部api.md]

**OpenRouter API配置:**
- 基础URL: https://openrouter.ai/api/v1
- 认证: Bearer Token（环境变量OPENROUTER_API_KEY）
- 速率限制: 60请求/分钟
- 支持模型: GPT-4、Claude、Gemini等多种模型
- 特色: 统一接口访问多种模型，成本控制，灵活选择

**DeepSeek API配置:**
- 基础URL: https://api.deepseek.com/v1
- 认证: API Key（环境变量DEEPSEEK_API_KEY）
- 速率限制: 100请求/分钟
- 支持模型: deepseek-chat、deepseek-coder
- 特色: 中文处理优秀，成本效益高，专业代码能力

### 错误处理和重试策略

**错误分类处理:**

```typescript
enum AIErrorType {
  AUTHENTICATION = 'authentication', // 认证失败
  RATE_LIMIT = 'rate_limit', // 速率限制
  INVALID_REQUEST = 'invalid_request', // 请求无效
  MODEL_UNAVAILABLE = 'model_unavailable', // 模型不可用
  NETWORK_ERROR = 'network_error', // 网络错误
  UNKNOWN_ERROR = 'unknown_error' // 未知错误
}

const RETRY_STRATEGIES = {
  [AIErrorType.RATE_LIMIT]: {
    maxRetries: 3,
    baseDelay: 2000, // 2秒
    backoffMultiplier: 2,
    maxDelay: 30000 // 30秒
  },
  [AIErrorType.NETWORK_ERROR]: {
    maxRetries: 3,
    baseDelay: 1000,
    backoffMultiplier: 1.5,
    maxDelay: 10000
  },
  [AIErrorType.MODEL_UNAVAILABLE]: {
    maxRetries: 1,
    fallbackToAlternativeModel: true
  }
};
```

### 使用情况跟踪和成本控制

**使用统计数据模型:**

```typescript
interface AIUsageRecord {
  id: string;
  provider: AIProvider;
  model: string;
  timestamp: Date;
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
  estimatedCost: number;
  requestType: string; // 请求类型标识
  responseTime: number; // 响应时间(ms)
  success: boolean;
  errorType?: AIErrorType;
}

interface UsageStatistics {
  totalRequests: number;
  totalTokens: number;
  totalCost: number;
  averageResponseTime: number;
  successRate: number;
  costBreakdownByProvider: ProviderCostBreakdown[];
  usageTrendByDay: DailyUsage[];
}

interface CostAlert {
  type: 'daily_limit' | 'monthly_limit' | 'usage_spike';
  threshold: number;
  currentValue: number;
  message: string;
  severity: 'info' | 'warning' | 'critical';
}
```

### 数据模型扩展 [Source: architecture/数据模型.md]

**新增AI服务配置和使用记录:**

```typescript
interface AIServiceConfiguration {
  id: string;
  provider: AIProvider;
  apiKey: string; // 加密存储
  baseUrl: string;
  defaultModel: string;
  isActive: boolean;
  rateLimitConfig: RateLimitConfig;
  costLimitConfig: CostLimitConfig;
  createdAt: Date;
  updatedAt: Date;
}

interface AIUsageTracking {
  id: string;
  configId: string;
  usageRecords: AIUsageRecord[];
  dailyStatistics: DailyUsageStatistics[];
  alerts: CostAlert[];
  lastUpdated: Date;
}

interface ModelCapability {
  model: string;
  provider: AIProvider;
  maxTokens: number;
  supportedFeatures: string[];
  costPerToken: number;
  strengthAreas: string[]; // 擅长领域
}
```

### 项目结构要求 [Source: architecture/源代码树.md]

**AI服务相关文件:**

```
lib/services/ai/
├── base-ai.service.ts              # AI服务基类
├── openrouter-ai.service.ts        # OpenRouter服务实现
├── deepseek-ai.service.ts          # DeepSeek服务实现
├── ai-service-factory.ts           # AI服务工厂
└── ai-model-registry.ts            # AI模型注册表

lib/config/
├── ai-config.manager.ts            # AI配置管理器
└── model-capabilities.config.ts    # 模型能力配置

lib/utils/
├── ai-retry.util.ts                # AI重试工具
├── cost-calculator.util.ts         # 成本计算工具
└── token-counter.util.ts           # Token计数工具

lib/trackers/
├── ai-usage.tracker.ts             # AI使用跟踪器
└── cost-monitor.tracker.ts         # 成本监控跟踪器

lib/types/
├── ai-service.types.ts             # AI服务类型定义
├── ai-usage.types.ts               # AI使用情况类型定义
└── ai-config.types.ts              # AI配置类型定义

components/settings/
├── ai-settings.tsx                 # AI设置主组件
├── provider-selection.tsx          # 提供商选择组件
├── model-configuration.tsx         # 模型配置组件
├── usage-dashboard.tsx             # 使用情况仪表盘
└── cost-alerts.tsx                 # 成本警告组件

app/api/ai/
├── config/route.ts                 # AI配置API
├── usage/route.ts                  # 使用统计API
├── models/route.ts                 # 支持模型API
└── health/route.ts                 # 健康检查API
```

### 性能和可靠性要求

**服务可靠性:**
- API调用成功率 > 99%
- 平均响应时间 < 3秒
- 重试机制覆盖率 100%
- 降级方案可用性 > 95%

**成本控制:**
- 实时成本跟踪精度 > 95%
- 成本预警及时性 < 5分钟
- 使用配额控制有效性 100%
- 成本优化建议准确性 > 85%

### 安全和隐私考虑

**API密钥安全:**
- 环境变量加密存储
- 密钥轮换支持
- 访问权限控制
- 密钥泄露检测

**数据安全:**
- API调用日志脱敏
- 敏感信息过滤
- 传输加密保护
- 本地存储安全

### Testing Requirements [Source: architecture/测试策略和标准.md]

**测试数据准备:**
- AI API模拟响应数据
- 各种错误场景测试用例
- 性能压力测试数据
- 成本计算验证数据

**测试指标:**
- API集成测试覆盖率（100%）
- 错误处理测试覆盖率（100%）
- 重试机制有效性（>95%）
- 成本跟踪准确性（>98%）

## Change Log

| Date       | Version | Description                        | Author       |
| ---------- | ------- | ---------------------------------- | ------------ |
| 2025-08-09 | 1.0     | 初始故事创建，基于Epic 5.1要求     | Scrum Master |

## Dev Agent Record

### Agent Model Used

待实现

### Debug Log References

待实现

### Completion Notes List

待实现

### File List

待实现

## QA Results

### Review Date

待审查

### Reviewed By

待指定