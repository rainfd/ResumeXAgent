# Story 5.3: 实现自定义 AI 分析功能

## Status

Draft

## Story

**As a** 用户，
**I want** 自定义 AI 的分析角度和方式，
**so that** 获得更个性化的求职建议

## Acceptance Criteria

1. 提供自定义 prompt 输入界面
2. 支持选择不同的 AI 模型
3. 提供常用分析模板（如"面试问题预测"、"职业发展建议"）
4. 支持保存和管理自定义 prompt
5. 展示 AI 分析结果并支持导出
6. 提供 prompt 编写的最佳实践指导

## Tasks / Subtasks

- [ ] Task 1: 创建自定义分析服务 (AC: 1, 2)
  - [ ] 创建 `lib/services/custom-analysis.service.ts` 自定义分析服务
  - [ ] 实现prompt模板处理功能
  - [ ] 开发动态模型选择机制
  - [ ] 集成变量替换和预处理
  - [ ] 添加分析结果结构化处理
- [ ] Task 2: 构建分析模板库 (AC: 3)
  - [ ] 创建 `lib/templates/analysis-templates.library.ts` 模板库
  - [ ] 实现面试问题预测模板
  - [ ] 开发职业发展建议模板
  - [ ] 添加薪资谈判策略模板
  - [ ] 实现行业趋势分析模板
  - [ ] 添加技能发展规划模板
- [ ] Task 3: 开发Prompt管理系统 (AC: 4)
  - [ ] 创建 `lib/services/prompt-manager.service.ts` Prompt管理服务
  - [ ] 实现自定义prompt保存功能
  - [ ] 开发prompt分类和标签系统
  - [ ] 添加prompt版本控制机制
  - [ ] 实现prompt分享和导入功能
- [ ] Task 4: 构建Prompt编写助手 (AC: 6)
  - [ ] 创建 `lib/helpers/prompt-writer.helper.ts` Prompt编写助手
  - [ ] 实现prompt语法检查功能
  - [ ] 开发变量和占位符智能提示
  - [ ] 添加最佳实践指导系统
  - [ ] 实现prompt效果预测功能
- [ ] Task 5: 开发结果展示和导出 (AC: 5)
  - [ ] 创建 `lib/exporters/analysis-result.exporter.ts` 结果导出器
  - [ ] 实现多格式导出支持（PDF、Word、Markdown）
  - [ ] 开发结果可视化功能
  - [ ] 添加结果对比和分析
  - [ ] 实现结果分享和协作功能
- [ ] Task 6: 创建自定义分析UI组件 (AC: 1-6)
  - [ ] 创建 `components/analysis/custom-analyzer.tsx` 自定义分析主组件
  - [ ] 实现prompt编辑器界面
  - [ ] 开发模型选择和配置面板
  - [ ] 添加模板库浏览和选择界面
  - [ ] 实现分析结果展示和导出界面
- [ ] Task 7: 集成自定义分析API (AC: 1-6)
  - [ ] 创建 `app/api/analysis/custom/route.ts` 自定义分析API
  - [ ] 实现prompt执行和结果处理
  - [ ] 集成模型选择和参数配置
  - [ ] 添加分析历史和结果存储
  - [ ] 实现prompt模板CRUD操作

## Dev Notes

### Previous Story Insights [Source: Story 5.1-5.2 Dev Notes]

- **AI服务基础设施完备**: 已建立统一的AI服务抽象层，支持OpenRouter/DeepSeek多模型调用
- **模型配置管理成熟**: 具备完整的模型选择、参数配置和使用跟踪能力
- **内容生成经验丰富**: 打招呼生成的提示词优化和质量评估经验可复用于自定义分析
- **用户界面基础稳固**: 已有AI配置和生成界面的设计模式可扩展为自定义分析界面

### 技术栈要求 [Source: architecture/技术栈.md]

- **AI服务**: OpenRouter API（多模型选择灵活性）+ DeepSeek API（中文分析优势）
- **数据库**: SQLite（自定义prompt和分析结果存储）
- **类型系统**: TypeScript 5.3.3（严格类型检查）
- **UI框架**: React 18.3.0 + shadcn/ui（自定义分析界面）

### 自定义分析架构设计

**自定义分析服务接口:**

```typescript
interface CustomAnalysisService {
  executeAnalysis(prompt: CustomPrompt, context: AnalysisContext): Promise<AnalysisResult>;
  validatePrompt(prompt: CustomPrompt): Promise<PromptValidation>;
  suggestImprovements(prompt: CustomPrompt): Promise<PromptSuggestion[]>;
  executeWithModel(prompt: CustomPrompt, model: AIModel, context: AnalysisContext): Promise<AnalysisResult>;
}

interface CustomPrompt {
  id: string;
  name: string;
  description: string;
  category: PromptCategory;
  template: string;
  variables: PromptVariable[];
  requiredContext: ContextRequirement[];
  expectedOutputFormat: OutputFormat;
  modelRecommendations: ModelRecommendation[];
  tags: string[];
  version: string;
  created_by: string;
  created_at: Date;
  updated_at: Date;
}

interface PromptVariable {
  name: string;
  type: 'text' | 'number' | 'date' | 'selection' | 'resume_field' | 'job_field';
  description: string;
  required: boolean;
  default_value?: any;
  validation_rules?: ValidationRule[];
  possible_values?: string[]; // 对于selection类型
}

interface AnalysisContext {
  resume?: Resume;
  job?: Job;
  user_input: Record<string, any>; // 用户输入的变量值
  analysis_goal: string;
  output_preferences: OutputPreferences;
}

interface AnalysisResult {
  id: string;
  prompt_id: string;
  model_used: string;
  execution_time: Date;
  content: string;
  structured_data?: Record<string, any>;
  confidence_score: number;
  token_usage: TokenUsage;
  quality_metrics: QualityMetrics;
  suggestions: string[];
}
```

### 分析模板库设计

**1. 面试问题预测模板:**

```typescript
const INTERVIEW_QUESTIONS_TEMPLATE: CustomPrompt = {
  name: "面试问题预测",
  description: "基于岗位要求和候选人背景，预测可能的面试问题",
  category: PromptCategory.INTERVIEW_PREPARATION,
  template: `
基于以下信息，预测这个岗位面试中可能被问到的问题：

岗位信息：
- 职位：{{job_title}}
- 公司：{{company_name}}
- 要求：{{job_requirements}}

候选人背景：
- 工作经验：{{work_experience}}
- 技能：{{skills}}
- 项目经历：{{projects}}

请生成以下类型的面试问题：
1. 技术问题（{{technical_questions_count}}个）
2. 行为问题（{{behavioral_questions_count}}个）
3. 情景问题（{{situational_questions_count}}个）
4. 公司文化相关问题（{{culture_questions_count}}个）

对每个问题，请提供：
- 问题内容
- 考察目的
- 回答要点
- STAR格式回答示例

输出格式：JSON结构化数据
`,
  variables: [
    { name: 'technical_questions_count', type: 'number', description: '技术问题数量', required: true, default_value: 5 },
    { name: 'behavioral_questions_count', type: 'number', description: '行为问题数量', required: true, default_value: 5 },
    { name: 'situational_questions_count', type: 'number', description: '情景问题数量', required: true, default_value: 3 },
    { name: 'culture_questions_count', type: 'number', description: '文化问题数量', required: true, default_value: 2 }
  ],
  requiredContext: ['resume', 'job'],
  expectedOutputFormat: OutputFormat.JSON
};
```

**2. 职业发展建议模板:**

```typescript
const CAREER_DEVELOPMENT_TEMPLATE: CustomPrompt = {
  name: "职业发展建议",
  description: "基于当前职业状况，提供个性化的职业发展建议",
  category: PromptCategory.CAREER_PLANNING,
  template: `
基于以下职业信息，提供个性化的职业发展建议：

当前状况：
- 工作年限：{{years_of_experience}}
- 当前职位：{{current_position}}
- 行业：{{industry}}
- 技能水平：{{skill_assessment}}

目标期望：
- 目标职位：{{target_position}}
- 期望时间框架：{{timeline}}
- 发展方向：{{development_direction}}

请提供以下维度的建议：
1. 技能发展路径
2. 经验积累建议
3. 网络建设策略
4. 学习资源推荐
5. 职业转换时机
6. 风险评估和应对

每个建议包括：
- 具体行动步骤
- 时间安排
- 成功指标
- 资源需求

输出格式：结构化报告
`,
  variables: [
    { name: 'years_of_experience', type: 'number', description: '工作年限', required: true },
    { name: 'current_position', type: 'text', description: '当前职位', required: true },
    { name: 'target_position', type: 'text', description: '目标职位', required: true },
    { name: 'timeline', type: 'selection', description: '期望时间框架', required: true, 
      possible_values: ['6个月内', '1年内', '2-3年', '3-5年', '长期规划'] },
    { name: 'development_direction', type: 'selection', description: '发展方向', required: true,
      possible_values: ['技术专家', '管理路线', '产品方向', '跨领域发展', '创业准备'] }
  ],
  requiredContext: ['resume'],
  expectedOutputFormat: OutputFormat.STRUCTURED_TEXT
};
```

**3. 薪资谈判策略模板:**

```typescript
const SALARY_NEGOTIATION_TEMPLATE: CustomPrompt = {
  name: "薪资谈判策略",
  description: "基于市场情况和个人背景，制定薪资谈判策略",
  category: PromptCategory.NEGOTIATION,
  template: `
基于以下信息，制定个性化的薪资谈判策略：

个人情况：
- 当前薪资：{{current_salary}}
- 工作经验：{{experience_level}}
- 核心技能：{{key_skills}}
- 过往成就：{{achievements}}

目标岗位：
- 岗位级别：{{position_level}}
- 公司规模：{{company_size}}
- 行业类型：{{industry_type}}
- 地理位置：{{location}}

市场调研：
- 行业平均薪资：{{market_average}}
- 薪资波动范围：{{salary_range}}
- 特殊技能加分：{{skill_premium}}

请提供：
1. 合理的薪资期望范围
2. 谈判时机和策略
3. 非薪资福利的谈判要点
4. 应对各种回应的策略
5. 谈判话术和表达方式
6. 底线和妥协空间

输出格式：实用指导手册
`,
  variables: [
    { name: 'current_salary', type: 'number', description: '当前薪资（千元/月）', required: true },
    { name: 'market_average', type: 'number', description: '市场平均薪资（千元/月）', required: false },
    { name: 'experience_level', type: 'selection', description: '经验水平', required: true,
      possible_values: ['初级（0-2年）', '中级（3-5年）', '高级（6-8年）', '专家级（8年+）'] },
    { name: 'company_size', type: 'selection', description: '公司规模', required: true,
      possible_values: ['创业公司', '中小企业', '大型企业', '跨国公司'] }
  ],
  requiredContext: ['resume', 'job'],
  expectedOutputFormat: OutputFormat.STRUCTURED_TEXT
};
```

### Prompt编写最佳实践指导

**Prompt质量评估维度:**

```typescript
interface PromptQualityAssessment {
  clarity_score: number; // 清晰度评分 (0-100)
  specificity_score: number; // 具体性评分 (0-100)
  structure_score: number; // 结构化程度 (0-100)
  variable_usage_score: number; // 变量使用合理性 (0-100)
  output_definition_score: number; // 输出定义清晰度 (0-100)
  overall_score: number; // 总体评分 (0-100)
  improvement_suggestions: PromptImprovement[];
}

interface PromptImprovement {
  aspect: 'clarity' | 'specificity' | 'structure' | 'variables' | 'output';
  current_issue: string;
  suggestion: string;
  example: string;
  impact_level: 'high' | 'medium' | 'low';
}

const PROMPT_BEST_PRACTICES = {
  structure: [
    "使用清晰的段落结构，明确区分输入、处理要求和输出格式",
    "采用编号或项目符号列出具体要求",
    "将复杂任务分解为多个子任务"
  ],
  clarity: [
    "使用具体、明确的指令，避免模糊表述",
    "定义专业术语和关键概念",
    "提供具体的示例和期望"
  ],
  variables: [
    "合理使用变量提高prompt复用性",
    "为每个变量提供清晰的描述和默认值",
    "验证变量的必要性，避免冗余变量"
  ],
  output: [
    "明确指定期望的输出格式（JSON、表格、段落等）",
    "定义输出的结构和字段",
    "设置合理的输出长度限制"
  ]
};
```

### 数据模型扩展 [Source: architecture/数据模型.md]

**新增自定义分析相关数据存储:**

```typescript
interface CustomAnalysisSession {
  id: string;
  prompt_id: string;
  model_used: string;
  context_data: AnalysisContext;
  execution_results: AnalysisResult[];
  user_feedback: UserFeedback;
  session_duration: number;
  created_at: Date;
}

interface PromptTemplate {
  id: string;
  name: string;
  description: string;
  category: PromptCategory;
  template_content: string;
  variables: PromptVariable[];
  usage_statistics: TemplateUsageStats;
  user_ratings: UserRating[];
  is_public: boolean;
  created_by: string;
  created_at: Date;
  updated_at: Date;
}

enum PromptCategory {
  INTERVIEW_PREPARATION = 'interview_preparation',
  CAREER_PLANNING = 'career_planning',
  SKILL_DEVELOPMENT = 'skill_development',
  NEGOTIATION = 'negotiation',
  MARKET_ANALYSIS = 'market_analysis',
  PERSONAL_BRANDING = 'personal_branding',
  NETWORKING = 'networking',
  CUSTOM = 'custom'
}

interface TemplateUsageStats {
  total_uses: number;
  success_rate: number;
  average_rating: number;
  common_modifications: string[];
  performance_metrics: PerformanceMetric[];
}
```

### 项目结构要求 [Source: architecture/源代码树.md]

**自定义分析相关文件:**

```
lib/services/
├── custom-analysis.service.ts          # 自定义分析主服务
└── prompt-manager.service.ts           # Prompt管理服务

lib/templates/
├── analysis-templates.library.ts       # 分析模板库
└── template-validator.ts               # 模板验证器

lib/helpers/
├── prompt-writer.helper.ts             # Prompt编写助手
├── variable-processor.helper.ts        # 变量处理助手
└── output-formatter.helper.ts          # 输出格式化助手

lib/exporters/
├── analysis-result.exporter.ts         # 分析结果导出器
└── report-generator.exporter.ts        # 报告生成器

lib/validators/
├── prompt-validator.ts                 # Prompt验证器
└── context-validator.ts                # 上下文验证器

lib/types/
├── custom-analysis.types.ts            # 自定义分析类型定义
├── prompt-template.types.ts            # Prompt模板类型定义
└── analysis-result.types.ts            # 分析结果类型定义

components/analysis/
├── custom-analyzer.tsx                 # 自定义分析主组件
├── prompt-editor.tsx                   # Prompt编辑器组件
├── template-browser.tsx                # 模板浏览器组件
├── variable-input-panel.tsx            # 变量输入面板
├── model-selector.tsx                  # 模型选择器
├── analysis-result-viewer.tsx          # 分析结果查看器
└── prompt-quality-indicator.tsx        # Prompt质量指示器

app/api/analysis/
├── custom/route.ts                     # 自定义分析API
├── template/route.ts                   # 模板管理API
└── export/route.ts                     # 结果导出API
```

### 性能和用户体验要求

**分析性能:**
- Prompt验证响应时间 < 2秒
- 自定义分析执行时间 < 15秒
- 模板加载和搜索即时响应
- 结果导出处理时间 < 5秒

**用户体验:**
- Prompt编辑器提供语法高亮和智能提示
- 变量输入界面直观易用
- 分析结果展示清晰可读
- 模板库浏览和搜索便捷高效

### 成本控制和优化

**AI调用优化策略:**
1. **Prompt预处理**: 优化prompt长度和结构减少token消耗
2. **模型选择智能**: 根据分析类型自动推荐最适合的模型
3. **结果缓存**: 相同prompt和上下文的结果缓存复用
4. **批量处理**: 支持多个相似分析任务的批量执行

### Testing Requirements [Source: architecture/测试策略和标准.md]

**测试数据准备:**
- 各类分析场景的prompt模板
- 不同复杂度的分析上下文数据
- Prompt质量评估标准数据
- 用户使用模式和反馈数据

**测试指标:**
- Prompt执行成功率（>95%）
- 分析结果质量评分（>85分）
- 用户满意度评价（>90%）
- 系统响应性能（<15秒完成分析）

### 安全和隐私考虑

**Prompt安全:**
- 用户输入内容安全检查
- 恶意prompt检测和防范
- 敏感信息过滤和保护
- 分析结果隐私保护

## Change Log

| Date       | Version | Description                        | Author       |
| ---------- | ------- | ---------------------------------- | ------------ |
| 2025-08-09 | 1.0     | 初始故事创建，基于Epic 5.3要求     | Scrum Master |

## Dev Agent Record

### Agent Model Used

待实现

### Debug Log References

待实现

### Completion Notes List

待实现

### File List

待实现

## QA Results

### Review Date

待审查

### Reviewed By

待指定