# Story 5.4: 创建简历定制化建议生成器

## Status

Draft

## Story

**As a** 用户，
**I want** AI 根据特定岗位为我的简历提供定制化建议，
**so that** 提高简历的针对性

## Acceptance Criteria

1. AI 分析岗位需求与简历的匹配情况
2. 生成针对性的简历调整建议
3. 推荐应该突出的项目和技能
4. 建议可以淡化或删除的内容
5. 提供调整后的简历预览
6. 支持一键应用 AI 建议的修改

## Tasks / Subtasks

- [ ] Task 1: 创建简历定制分析服务 (AC: 1, 2)
  - [ ] 创建 `lib/services/resume-customization.service.ts` 简历定制服务
  - [ ] 实现岗位需求解析算法
  - [ ] 开发简历匹配度评估功能
  - [ ] 集成定制化建议生成机制
  - [ ] 添加建议可行性评估
- [ ] Task 2: 构建内容优先级分析器 (AC: 3, 4)
  - [ ] 创建 `lib/analyzers/content-priority.analyzer.ts` 内容优先级分析器
  - [ ] 实现技能重要性评估算法
  - [ ] 开发项目经历相关性分析
  - [ ] 添加经验匹配度计算
  - [ ] 实现内容淡化和删除建议
- [ ] Task 3: 开发简历预览生成器 (AC: 5)
  - [ ] 创建 `lib/generators/resume-preview.generator.ts` 简历预览生成器
  - [ ] 实现调整后简历渲染功能
  - [ ] 开发对比视图生成
  - [ ] 添加变更高亮显示
  - [ ] 实现多种预览格式支持
- [ ] Task 4: 构建建议应用系统 (AC: 6)
  - [ ] 创建 `lib/applicators/suggestion-applicator.ts` 建议应用器
  - [ ] 实现一键建议应用功能
  - [ ] 开发选择性建议应用
  - [ ] 添加应用结果验证
  - [ ] 实现应用操作回滚机制
- [ ] Task 5: 开发匹配度评分系统 (AC: 1)
  - [ ] 创建 `lib/scorers/job-resume-match.scorer.ts` 匹配度评分器
  - [ ] 实现多维度匹配评分算法
  - [ ] 开发匹配度可视化支持
  - [ ] 添加改进潜力预测功能
  - [ ] 实现匹配度趋势分析
- [ ] Task 6: 创建简历定制UI组件 (AC: 1-6)
  - [ ] 创建 `components/customization/resume-customizer.tsx` 简历定制主组件
  - [ ] 实现匹配度分析展示界面
  - [ ] 开发建议列表和优先级显示
  - [ ] 添加简历预览和对比界面
  - [ ] 实现建议应用操作界面
- [ ] Task 7: 集成简历定制API (AC: 1-6)
  - [ ] 创建 `app/api/customization/resume/route.ts` 简历定制API
  - [ ] 实现岗位简历匹配分析
  - [ ] 集成定制建议生成服务
  - [ ] 添加预览生成和建议应用
  - [ ] 实现定制历史记录管理

## Dev Notes

### Previous Story Insights [Source: Story 4.1-4.5 & 5.1-5.3 Dev Notes]

- **简历分析框架成熟**: Epic 4已建立完整的STAR、充实度、项目优化、技能分析和整体优化框架
- **AI服务基础设施完备**: Epic 5已建立统一AI服务层，支持多模型调用和自定义分析
- **岗位匹配经验丰富**: 已有岗位与简历匹配分析的技术基础和算法积累
- **内容生成和优化成熟**: 具备内容生成、质量评估和用户交互的完整解决方案

### 技术栈要求 [Source: architecture/技术栈.md]

- **AI服务**: OpenRouter API（多模型对比定制效果）+ DeepSeek API（中文简历定制优化）
- **数据库**: SQLite（定制建议和应用历史存储）
- **类型系统**: TypeScript 5.3.3（严格类型检查）
- **UI框架**: React 18.3.0 + shadcn/ui（简历定制界面）

### 简历定制架构设计

**简历定制服务接口:**

```typescript
interface ResumeCustomizationService {
  analyzeJobResumeMatch(resume: Resume, job: Job): Promise<MatchAnalysisResult>;
  generateCustomizationSuggestions(matchAnalysis: MatchAnalysisResult): Promise<CustomizationSuggestion[]>;
  prioritizeContent(resume: Resume, job: Job): Promise<ContentPriority>;
  generateCustomizedPreview(resume: Resume, suggestions: CustomizationSuggestion[]): Promise<CustomizedResume>;
  applySuggestions(resume: Resume, selectedSuggestions: string[]): Promise<ApplyResult>;
}

interface MatchAnalysisResult {
  overall_match_score: number; // 整体匹配度 (0-100)
  detailed_matching: DetailedMatching;
  gap_analysis: GapAnalysis;
  customization_potential: number; // 定制化改进潜力 (0-100)
  priority_adjustments: PriorityAdjustment[];
}

interface DetailedMatching {
  skills_match: SkillsMatching;
  experience_match: ExperienceMatching;
  education_match: EducationMatching;
  projects_match: ProjectsMatching;
  achievements_match: AchievementsMatching;
}

interface CustomizationSuggestion {
  id: string;
  type: SuggestionType;
  category: 'highlight' | 'add' | 'modify' | 'remove' | 'reorder';
  priority: 'high' | 'medium' | 'low';
  impact_score: number; // 预期影响分数 (0-100)
  
  // 具体建议内容
  title: string;
  description: string;
  current_content?: string;
  suggested_content?: string;
  reasoning: string;
  
  // 应用信息
  section: ResumeSection;
  field_path: string; // 字段路径，如 "work_experience.0.description"
  operation: Operation;
  confidence_level: number;
}

enum SuggestionType {
  SKILL_HIGHLIGHT = 'skill_highlight', // 技能突出
  PROJECT_EMPHASIZE = 'project_emphasize', // 项目强调
  EXPERIENCE_ADJUST = 'experience_adjust', // 经验调整
  KEYWORD_OPTIMIZE = 'keyword_optimize', // 关键词优化
  CONTENT_REORDER = 'content_reorder', // 内容重排
  SECTION_BALANCE = 'section_balance', // 章节平衡
  RELEVANCE_FILTER = 'relevance_filter', // 相关性过滤
  ACHIEVEMENT_HIGHLIGHT = 'achievement_highlight' // 成就突出
}

interface ContentPriority {
  high_priority_items: PriorityItem[];
  medium_priority_items: PriorityItem[];
  low_priority_items: PriorityItem[];
  suggested_removals: RemovalSuggestion[];
  reordering_suggestions: ReorderSuggestion[];
}

interface PriorityItem {
  content_id: string;
  section: ResumeSection;
  content_preview: string;
  relevance_score: number;
  uniqueness_score: number;
  impact_potential: number;
  positioning_suggestion: string;
}
```

### 定制化分析核心算法

**1. 岗位需求匹配算法:**

```typescript
interface JobRequirementMatcher {
  extractKeyRequirements(job: Job): JobRequirement[];
  scoreResumeAgainstRequirements(resume: Resume, requirements: JobRequirement[]): RequirementScore[];
  identifyGaps(resume: Resume, requirements: JobRequirement[]): RequirementGap[];
  suggestImprovements(gaps: RequirementGap[], resume: Resume): ImprovementSuggestion[];
}

interface JobRequirement {
  type: 'must_have' | 'nice_to_have' | 'preferred';
  category: 'technical_skill' | 'soft_skill' | 'experience' | 'education' | 'certification';
  requirement: string;
  importance_weight: number; // 重要程度权重 (0-1)
  keywords: string[]; // 相关关键词
}

interface RequirementScore {
  requirement: JobRequirement;
  match_level: number; // 匹配程度 (0-100)
  evidence: ResumeEvidence[]; // 简历中的证据
  gap_description?: string; // 差距描述
  improvement_suggestion?: string; // 改进建议
}

const calculateMatchScore = (resume: Resume, job: Job): number => {
  const requirements = extractKeyRequirements(job);
  const scores = requirements.map(req => {
    const evidence = findEvidenceInResume(resume, req);
    return {
      weight: req.importance_weight,
      score: evaluateEvidence(evidence, req)
    };
  });
  
  return scores.reduce((total, { weight, score }) => {
    return total + (weight * score);
  }, 0) / scores.reduce((sum, { weight }) => sum + weight, 0);
};
```

**2. 内容优先级算法:**

```typescript
interface ContentPrioritizer {
  analyzeRelevance(content: ResumeContent, job: Job): number;
  assessUniqueness(content: ResumeContent, commonPatterns: Pattern[]): number;
  evaluateImpact(content: ResumeContent, targetAudience: AudienceProfile): number;
  calculatePriority(relevance: number, uniqueness: number, impact: number): number;
}

const PRIORITY_WEIGHTS = {
  relevance: 0.5, // 相关性权重最高
  uniqueness: 0.3, // 独特性其次
  impact: 0.2 // 影响力最后
};

const calculateContentPriority = (content: ResumeContent, job: Job): number => {
  const relevance = analyzeJobRelevance(content, job);
  const uniqueness = assessContentUniqueness(content);
  const impact = evaluateBusinessImpact(content);
  
  return (
    relevance * PRIORITY_WEIGHTS.relevance +
    uniqueness * PRIORITY_WEIGHTS.uniqueness +
    impact * PRIORITY_WEIGHTS.impact
  );
};
```

**3. 简历预览生成算法:**

```typescript
interface ResumePreviewGenerator {
  generatePreview(original: Resume, suggestions: CustomizationSuggestion[]): CustomizedResume;
  highlightChanges(original: Resume, customized: CustomizedResume): ChangeHighlight[];
  renderComparison(original: Resume, customized: CustomizedResume): ComparisonView;
  validateCustomization(customized: CustomizedResume): ValidationResult;
}

interface ChangeHighlight {
  section: ResumeSection;
  change_type: 'added' | 'modified' | 'removed' | 'reordered';
  original_content?: string;
  new_content?: string;
  reasoning: string;
  impact_description: string;
}

const generateCustomizedResume = (original: Resume, suggestions: CustomizationSuggestion[]): CustomizedResume => {
  let customized = deepClone(original);
  
  // 按优先级和依赖关系排序建议
  const sortedSuggestions = sortSuggestionsByPriorityAndDependency(suggestions);
  
  for (const suggestion of sortedSuggestions) {
    customized = applySuggestionToResume(customized, suggestion);
  }
  
  return {
    ...customized,
    customization_metadata: {
      applied_suggestions: suggestions.map(s => s.id),
      customization_score: calculateCustomizationScore(original, customized),
      estimated_improvement: estimateMatchImprovement(original, customized)
    }
  };
};
```

### AI提示词策略

**简历定制分析提示词模板:**

```
请基于以下岗位要求，为候选人简历提供定制化建议：

岗位信息：
- 职位名称：[JOB_TITLE]
- 公司信息：[COMPANY_INFO]
- 岗位要求：[JOB_REQUIREMENTS]
- 关键技能：[KEY_SKILLS]
- 经验要求：[EXPERIENCE_REQUIREMENTS]

候选人简历：
- 基本信息：[BASIC_INFO]
- 工作经验：[WORK_EXPERIENCE]
- 项目经历：[PROJECT_EXPERIENCE]
- 技能列表：[SKILLS]
- 教育背景：[EDUCATION]

分析要求：
1. 匹配度分析：
   - 计算当前简历与岗位的匹配程度
   - 识别强项和差距
   - 评估改进潜力

2. 定制化建议：
   - 需要突出强调的内容
   - 需要调整或优化的部分
   - 可以淡化或删除的内容
   - 内容重排和结构调整建议

3. 具体修改建议：
   - 关键词优化建议
   - 项目描述改进建议
   - 技能展示优化建议
   - 成就量化建议

4. 优先级排序：
   - 按影响程度排序建议
   - 标注实施难度
   - 预测改进效果

输出要求：
- 提供具体可执行的建议
- 每个建议包含修改前后对比
- 说明修改理由和预期效果
- 评估整体改进潜力

以JSON格式返回结构化建议。
```

### 数据模型扩展 [Source: architecture/数据模型.md]

**新增简历定制相关数据存储:**

```typescript
interface ResumeCustomization {
  id: string;
  resume_id: string;
  job_id: string;
  match_analysis: MatchAnalysisResult;
  generated_suggestions: CustomizationSuggestion[];
  applied_suggestions: string[]; // 已应用的建议ID
  customized_resume: CustomizedResume;
  improvement_metrics: ImprovementMetrics;
  user_feedback: CustomizationFeedback;
  created_at: Date;
  updated_at: Date;
}

interface CustomizedResume extends Resume {
  customization_metadata: {
    original_resume_id: string;
    applied_suggestions: string[];
    customization_score: number;
    estimated_improvement: number;
    change_summary: ChangeSummary;
  };
}

interface ChangeSummary {
  sections_modified: string[];
  content_added: number;
  content_removed: number;
  content_reordered: number;
  keywords_optimized: number;
  overall_impact: number;
}

interface ImprovementMetrics {
  match_score_before: number;
  match_score_after: number;
  improvement_percentage: number;
  key_improvements: KeyImprovement[];
  estimated_success_rate: number;
}

interface CustomizationFeedback {
  usefulness_rating: number; // 1-5分
  applied_suggestions_rating: number;
  preview_quality_rating: number;
  ease_of_use_rating: number;
  specific_feedback: string;
  would_recommend: boolean;
}
```

### 项目结构要求 [Source: architecture/源代码树.md]

**简历定制相关文件:**

```
lib/services/
└── resume-customization.service.ts     # 简历定制主服务

lib/analyzers/
├── content-priority.analyzer.ts        # 内容优先级分析器
├── job-requirement.analyzer.ts         # 岗位需求分析器
└── match-improvement.analyzer.ts       # 匹配改进分析器

lib/generators/
├── resume-preview.generator.ts         # 简历预览生成器
├── suggestion-generator.ts             # 建议生成器
└── comparison-view.generator.ts        # 对比视图生成器

lib/applicators/
├── suggestion-applicator.ts            # 建议应用器
└── content-modifier.ts                 # 内容修改器

lib/scorers/
├── job-resume-match.scorer.ts          # 岗位简历匹配评分器
├── improvement-impact.scorer.ts        # 改进影响评分器
└── customization-quality.scorer.ts     # 定制化质量评分器

lib/types/
├── resume-customization.types.ts       # 简历定制类型定义
├── match-analysis.types.ts             # 匹配分析类型定义
└── customization-suggestion.types.ts   # 定制建议类型定义

components/customization/
├── resume-customizer.tsx               # 简历定制主组件
├── match-analysis-display.tsx          # 匹配分析展示组件
├── suggestion-list.tsx                 # 建议列表组件
├── resume-preview-comparison.tsx       # 简历预览对比组件
├── suggestion-applicator.tsx           # 建议应用组件
└── customization-progress.tsx          # 定制进度组件

app/api/customization/
├── resume/route.ts                     # 简历定制API
├── analysis/route.ts                   # 匹配分析API
└── apply/route.ts                      # 建议应用API
```

### 性能和用户体验要求

**定制性能:**
- 匹配分析完成时间 < 10秒
- 建议生成响应时间 < 8秒
- 简历预览生成时间 < 5秒
- 建议应用操作即时完成

**用户体验:**
- 匹配度可视化清晰直观
- 建议列表按优先级排序明确
- 预览对比界面清晰易读
- 建议应用操作简单流畅

### 质量保证和验证

**定制质量评估:**
1. **匹配度提升验证**: 定制前后匹配度对比
2. **建议可行性验证**: 建议的实际可执行性检查
3. **内容完整性验证**: 定制后简历内容完整性检查
4. **逻辑一致性验证**: 修改后内容逻辑一致性验证

### Testing Requirements [Source: architecture/测试策略和标准.md]

**测试数据准备:**
- 不同行业和岗位的JD样本
- 各种背景和经验的简历数据
- 定制建议质量评估标准
- 用户应用建议的效果数据

**测试指标:**
- 匹配度分析准确性（>90%）
- 建议相关性评估（>88%）
- 预览生成准确性（>95%）
- 用户满意度评价（>85%）

### 安全和隐私考虑

**数据安全:**
- 简历内容隐私保护
- 定制建议安全性检查
- 用户操作记录隐私保护
- 敏感信息脱敏处理

## Change Log

| Date       | Version | Description                        | Author       |
| ---------- | ------- | ---------------------------------- | ------------ |
| 2025-08-09 | 1.0     | 初始故事创建，基于Epic 5.4要求     | Scrum Master |

## Dev Agent Record

### Agent Model Used

待实现

### Debug Log References

待实现

### Completion Notes List

待实现

### File List

待实现

## QA Results

### Review Date

待审查

### Reviewed By

待指定