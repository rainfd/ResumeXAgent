# Story 6.1: 构建 AI 匹配分析基础

## Status

Draft

## Story

**As a** 开发者，
**I want** 建立基于 AI 的匹配分析框架，
**so that** 快速实现智能匹配功能

## Acceptance Criteria

1. 创建匹配分析的 API 调用封装
2. 设计 AI 匹配分析的 prompt 模板
3. 实现简历和岗位数据的组合输入格式
4. 创建匹配结果的解析和存储机制
5. 支持不同 AI 模型的匹配分析
6. 建立匹配历史记录功能

## Tasks / Subtasks

- [ ] Task 1: 创建AI匹配分析服务基础 (AC: 1, 5)
  - [ ] 创建 `lib/services/ai-match-analyzer.service.ts` AI匹配分析服务
  - [ ] 实现多模型匹配分析支持
  - [ ] 开发匹配分析API调用封装
  - [ ] 集成AI服务统一接口
  - [ ] 添加分析结果标准化处理
- [ ] Task 2: 构建匹配分析Prompt模板系统 (AC: 2)
  - [ ] 创建 `lib/prompts/match-analysis.prompts.ts` 匹配分析提示词库
  - [ ] 设计技能匹配分析模板
  - [ ] 开发经验匹配分析模板
  - [ ] 添加综合匹配分析模板
  - [ ] 实现模板动态组装功能
- [ ] Task 3: 开发数据输入格式标准化 (AC: 3)
  - [ ] 创建 `lib/formatters/match-input.formatter.ts` 匹配输入格式化器
  - [ ] 实现简历数据结构化处理
  - [ ] 开发岗位信息标准化格式
  - [ ] 添加数据组合和预处理
  - [ ] 实现输入数据验证机制
- [ ] Task 4: 构建匹配结果处理系统 (AC: 4, 6)
  - [ ] 创建 `lib/processors/match-result.processor.ts` 匹配结果处理器
  - [ ] 实现AI响应解析功能
  - [ ] 开发结构化结果提取
  - [ ] 添加匹配分数计算和校验
  - [ ] 实现结果存储和历史管理
- [ ] Task 5: 开发匹配历史记录系统 (AC: 6)
  - [ ] 创建 `lib/services/match-history.service.ts` 匹配历史服务
  - [ ] 实现匹配记录存储功能
  - [ ] 开发历史查询和筛选
  - [ ] 添加匹配趋势分析
  - [ ] 实现历史数据统计和洞察
- [ ] Task 6: 构建匹配分析评估器 (AC: 1-6)
  - [ ] 创建 `lib/evaluators/match-quality.evaluator.ts` 匹配质量评估器
  - [ ] 实现匹配结果质量评分
  - [ ] 开发一致性验证功能
  - [ ] 添加置信度评估机制
  - [ ] 实现匹配准确性跟踪
- [ ] Task 7: 创建匹配分析管理界面 (AC: 1-6)
  - [ ] 创建 `components/matching/match-analyzer.tsx` 匹配分析主组件
  - [ ] 实现匹配分析配置界面
  - [ ] 开发分析结果展示组件
  - [ ] 添加历史记录查看界面
  - [ ] 实现分析质量监控面板
- [ ] Task 8: 集成匹配分析API接口 (AC: 1-6)
  - [ ] 创建 `app/api/matching/analyze/route.ts` 匹配分析API
  - [ ] 实现单次匹配分析接口
  - [ ] 集成批量匹配分析功能
  - [ ] 添加匹配历史查询接口
  - [ ] 实现分析质量评估API

## Dev Notes

### Previous Story Insights [Source: Story 5.1-5.5 Dev Notes]

- **AI服务基础设施完备**: Epic 5建立的统一AI服务层提供了稳定的多模型调用基础
- **Prompt工程经验成熟**: 自定义分析和各种内容生成的Prompt优化经验可直接应用于匹配分析
- **数据处理流程标准化**: 已有完整的简历和岗位数据结构化处理能力
- **质量评估体系完善**: 具备AI生成内容的质量评估和改进机制

### 技术栈要求 [Source: architecture/技术栈.md]

- **AI服务**: OpenRouter API（多模型匹配对比）+ DeepSeek API（中文匹配语义理解）
- **数据库**: SQLite（匹配分析结果和历史记录存储）
- **类型系统**: TypeScript 5.3.3（严格类型检查）
- **UI框架**: React 18.3.0 + shadcn/ui（匹配分析界面）

### 匹配分析架构设计

**AI匹配分析服务接口:**

```typescript
interface AIMatchAnalyzer {
  analyzeMatch(resume: Resume, job: Job, options: MatchAnalysisOptions): Promise<MatchAnalysisResult>;
  batchAnalyze(resume: Resume, jobs: Job[], options: BatchAnalysisOptions): Promise<BatchMatchResult>;
  reanalyzeWithDifferentModel(matchId: string, model: AIModel): Promise<MatchAnalysisResult>;
  validateMatchResult(result: MatchAnalysisResult): Promise<ValidationResult>;
  compareMatchResults(results: MatchAnalysisResult[]): Promise<ComparisonResult>;
}

interface MatchAnalysisOptions {
  model: AIModel;
  depth: 'basic' | 'detailed' | 'comprehensive';
  focus_areas: MatchFocusArea[];
  include_suggestions: boolean;
  language: 'zh' | 'en';
  custom_weights?: MatchWeights;
}

interface MatchAnalysisResult {
  id: string;
  resume_id: string;
  job_id: string;
  analysis_model: string;
  analysis_timestamp: Date;
  
  // 核心匹配分数
  overall_match_score: number; // 0-100
  confidence_level: number; // 0-100
  
  // 详细匹配分析
  skill_match: SkillMatchAnalysis;
  experience_match: ExperienceMatchAnalysis;
  education_match: EducationMatchAnalysis;
  culture_match: CultureMatchAnalysis;
  
  // AI洞察和建议
  ai_insights: AIInsight[];
  improvement_suggestions: ImprovementSuggestion[];
  risk_factors: RiskFactor[];
  
  // 元数据
  analysis_quality: AnalysisQuality;
  token_usage: TokenUsage;
  processing_time: number;
}

interface SkillMatchAnalysis {
  matched_skills: SkillMatch[];
  missing_skills: MissingSkill[];
  transferable_skills: TransferableSkill[];
  skill_gap_score: number; // 技能差距评分
  improvement_priority: SkillPriority[];
}

interface SkillMatch {
  required_skill: string;
  candidate_skill: string;
  match_level: 'exact' | 'similar' | 'related' | 'transferable';
  match_confidence: number;
  evidence: string[]; // 简历中的证据
  proficiency_assessment: ProficiencyLevel;
}
```

### 匹配分析Prompt模板设计

**综合匹配分析主模板:**

```typescript
const COMPREHENSIVE_MATCH_ANALYSIS_TEMPLATE = `
请对以下候选人简历与目标岗位进行全面的匹配分析：

=== 岗位信息 ===
职位名称：{job_title}
公司：{company_name}
岗位描述：{job_description}
任职要求：{job_requirements}
技能要求：{required_skills}
经验要求：{experience_requirements}
学历要求：{education_requirements}

=== 候选人简历 ===
基本信息：{basic_info}
工作经验：{work_experience}
项目经历：{project_experience}
技能列表：{skills}
教育背景：{education}
其他信息：{additional_info}

=== 分析要求 ===
请从以下维度进行深度分析：

1. 技能匹配分析 (权重: 40%)
   - 识别完全匹配的技能
   - 识别相似或可替代的技能
   - 评估技能水平和熟练程度
   - 识别关键技能缺失
   - 提供技能提升建议

2. 经验匹配分析 (权重: 35%)
   - 分析工作经验相关性
   - 评估项目经历匹配度
   - 识别可转移的经验
   - 评估经验深度和广度
   - 发现隐藏的匹配亮点

3. 教育背景匹配 (权重: 15%)
   - 评估学历要求匹配
   - 分析专业相关性
   - 考虑培训和认证
   - 评估持续学习能力

4. 文化契合度 (权重: 10%)
   - 分析价值观匹配
   - 评估工作风格契合
   - 考虑团队适应性
   - 分析发展潜力

=== 输出要求 ===
请提供结构化的分析结果，包括：

1. 整体匹配评分 (0-100分)
2. 各维度详细分析和评分
3. 具体匹配点和差距说明
4. 改进建议和行动计划
5. 风险因素和注意事项
6. 面试准备重点建议

输出格式：JSON结构化数据
分析语言：中文
分析深度：{analysis_depth}
`;
```

**技能匹配专项模板:**

```typescript
const SKILL_MATCH_ANALYSIS_TEMPLATE = `
请专门分析候选人技能与岗位技能要求的匹配情况：

=== 岗位技能要求 ===
必备技能：{required_skills}
优先技能：{preferred_skills}
技能水平要求：{skill_levels}

=== 候选人技能 ===
技术技能：{technical_skills}
软技能：{soft_skills}
工具技能：{tool_skills}
技能经验年限：{skill_experience}

=== 分析要求 ===
1. 技能匹配度分析
   - 完全匹配的技能及证据
   - 部分匹配或相似技能
   - 可转移和相关技能
   - 技能水平评估

2. 技能差距识别
   - 明确缺失的关键技能
   - 技能水平不足的方面
   - 技能深度和广度分析

3. 改进建议
   - 优先提升的技能列表
   - 具体学习路径建议
   - 技能证明方式建议
   - 预估学习时间

请以JSON格式返回详细的技能匹配分析结果。
`;
```

### 数据输入格式标准化

**匹配分析输入数据结构:**

```typescript
interface MatchAnalysisInput {
  resume_data: StandardizedResume;
  job_data: StandardizedJob;
  analysis_config: AnalysisConfiguration;
  context_info: ContextInformation;
}

interface StandardizedResume {
  // 标准化的简历数据结构
  basic_info: {
    name: string;
    contact: ContactInfo;
    location: string;
    availability: string;
  };
  
  professional_summary: string;
  
  work_experience: WorkExperience[];
  project_experience: ProjectExperience[];
  education: Education[];
  skills: SkillSet;
  certifications: Certification[];
  achievements: Achievement[];
  
  // 元数据
  resume_quality_score: number;
  last_updated: Date;
  completeness_percentage: number;
}

interface StandardizedJob {
  // 标准化的岗位数据结构
  basic_info: {
    title: string;
    company: string;
    location: string;
    employment_type: string;
    salary_range?: SalaryRange;
  };
  
  job_description: string;
  key_responsibilities: string[];
  required_qualifications: Qualification[];
  preferred_qualifications: Qualification[];
  required_skills: SkillRequirement[];
  company_culture: CultureInfo;
  
  // 元数据
  job_posting_date: Date;
  application_deadline?: Date;
  urgency_level: 'low' | 'medium' | 'high';
}

interface AnalysisConfiguration {
  depth_level: 'basic' | 'detailed' | 'comprehensive';
  focus_dimensions: MatchDimension[];
  custom_weights: Record<string, number>;
  include_suggestions: boolean;
  suggestion_detail_level: 'summary' | 'detailed' | 'actionable';
  comparison_benchmarks?: BenchmarkData[];
}
```

### 匹配结果处理和存储

**匹配历史记录数据模型:**

```typescript
interface MatchHistory {
  id: string;
  user_id: string;
  resume_id: string;
  job_id: string;
  analysis_results: MatchAnalysisResult[];
  best_match_score: number;
  analysis_evolution: AnalysisEvolution[];
  user_actions: UserAction[];
  outcome: MatchOutcome;
  created_at: Date;
  updated_at: Date;
}

interface AnalysisEvolution {
  version: number;
  model_used: string;
  analysis_date: Date;
  score_changes: ScoreChange[];
  improvement_applied: ImprovementAction[];
  notes: string;
}

interface UserAction {
  action_type: 'applied_suggestion' | 'updated_resume' | 'applied_job' | 'bookmarked' | 'shared';
  action_date: Date;
  action_details: Record<string, any>;
  impact_on_score?: number;
}

interface MatchOutcome {
  application_submitted: boolean;
  application_date?: Date;
  interview_received?: boolean;
  interview_date?: Date;
  final_result?: 'hired' | 'rejected' | 'pending' | 'withdrawn';
  feedback_received?: string;
  lessons_learned?: string[];
}
```

### 项目结构要求 [Source: architecture/源代码树.md]

**匹配分析基础相关文件:**

```
lib/services/
├── ai-match-analyzer.service.ts        # AI匹配分析主服务
└── match-history.service.ts            # 匹配历史服务

lib/prompts/
├── match-analysis.prompts.ts           # 匹配分析提示词库
├── skill-match.prompts.ts              # 技能匹配提示词
└── experience-match.prompts.ts         # 经验匹配提示词

lib/formatters/
├── match-input.formatter.ts            # 匹配输入格式化器
└── resume-job-combiner.ts              # 简历岗位数据组合器

lib/processors/
├── match-result.processor.ts           # 匹配结果处理器
├── ai-response.parser.ts               # AI响应解析器
└── match-score.calculator.ts           # 匹配分数计算器

lib/evaluators/
├── match-quality.evaluator.ts          # 匹配质量评估器
├── consistency.validator.ts            # 一致性验证器
└── confidence.assessor.ts              # 置信度评估器

lib/types/
├── match-analysis.types.ts             # 匹配分析类型定义
├── match-history.types.ts              # 匹配历史类型定义
└── match-configuration.types.ts        # 匹配配置类型定义

components/matching/
├── match-analyzer.tsx                  # 匹配分析主组件
├── analysis-configurator.tsx           # 分析配置器
├── match-result-display.tsx            # 匹配结果展示
├── history-viewer.tsx                  # 历史记录查看器
└── quality-monitor.tsx                 # 质量监控面板

app/api/matching/
├── analyze/route.ts                    # 匹配分析API
├── history/route.ts                    # 历史记录API
└── quality/route.ts                    # 质量评估API
```

### 性能和可靠性要求

**分析性能:**
- 单次匹配分析完成时间 < 15秒
- 批量分析支持并发处理
- 分析结果缓存机制
- 历史查询响应时间 < 3秒

**可靠性保证:**
- 分析结果一致性验证
- 多模型结果交叉验证
- 异常情况降级处理
- 分析质量监控告警

### AI成本控制策略

**成本优化措施:**
1. **智能缓存**: 相似简历-岗位组合复用分析结果
2. **分层分析**: 根据需求选择分析深度和模型
3. **批量处理**: 优化AI调用频次和Token使用
4. **质量阈值**: 设置分析质量门槛，避免低质量重复分析

### Testing Requirements [Source: architecture/测试策略和标准.md]

**测试数据准备:**
- 不同质量和类型的简历样本
- 各行业和岗位级别的JD数据
- 已知匹配结果的基准测试集
- 多模型分析结果对比数据

**测试指标:**
- 分析结果一致性（>90%）
- 匹配分数准确性（±5分误差范围）
- 处理性能达标率（>95%）
- 用户满意度评价（>85%）

### 安全和隐私考虑

**数据安全:**
- 匹配分析过程数据加密
- 历史记录访问权限控制
- 敏感信息脱敏处理
- 分析结果定期清理

## Change Log

| Date       | Version | Description                        | Author       |
| ---------- | ------- | ---------------------------------- | ------------ |
| 2025-08-09 | 1.0     | 初始故事创建，基于Epic 6.1要求     | Scrum Master |

## Dev Agent Record

### Agent Model Used

待实现

### Debug Log References

待实现

### Completion Notes List

待实现

### File List

待实现

## QA Results

### Review Date

待审查

### Reviewed By

待指定